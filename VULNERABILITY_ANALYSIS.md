# Security Vulnerability Analysis
## ActEd Calendar Server vs. Python Web Security Checklist

Based on: https://levi.id.au/articles/computers/python-web-security/

---

## 1. HTML Injection / Cross-Site Scripting (XSS)

### Status: âœ… **PROTECTED**

**Why we're protected:**
- HTML content in calendar_server.py:185-792 is mostly static
- Dynamic content uses `textContent` assignment (line 441, 451, 455, 462, 471, 477)
- Modal content created with `document.createElement()` (lines 432-467)
- All deadline data inserted via DOM methods, not innerHTML
- Git history shows XSS fix in commit `2ac527c`

**Potential concern:**
- Line 756: `{group}` inserted in onclick handler needs validation
- Line 772: `{group}` in onclick for "ALL" calendar

**Mitigation:**
- Module groups are from database enum (CM1, CM2, etc.) - not user input
- Groups validated at database level (lines 66-70)
- No arbitrary user input reaches HTML

**Risk Level:** ğŸŸ¢ **LOW** - Only controlled enum values displayed

---

## 2. SQL Injection

### Status: âœ… **PROTECTED**

**Why we're protected:**
- **ALL** database queries use parameterized statements
- Line 99-110: `INSERT OR REPLACE` with `?` placeholders
- Line 122-127: `SELECT` with `?` parameter binding
- Line 145-150: Query uses proper SQLite parameterization
- No string concatenation in SQL queries

**Code example (line 122-127):**
```python
cursor.execute('''
    SELECT module_code, assignment_code, title, deadline_date, recommend_date
    FROM deadlines
    WHERE module_group = ? AND is_active = 1
    ORDER BY deadline_date, module_code
''', (module_group.upper(),))
```

**Risk Level:** ğŸŸ¢ **NONE** - Industry best practice followed

---

## 3. Email Header Injection

### Status: âœ… **NOT APPLICABLE**

**Why we're not vulnerable:**
- Application does not send emails
- No email functionality in codebase
- No SMTP, sendmail, or mail() calls
- No email-related imports

**Risk Level:** ğŸŸ¢ **N/A** - Feature not present

---

## 4. Shell Parameter Execution

### Status: âœ… **PROTECTED**

**Why we're protected:**
- No `os.system()` calls
- No `subprocess.run()`, `subprocess.call()`, or `subprocess.Popen()`
- No `eval()` or `exec()` calls
- No shell command execution anywhere in code

**Import analysis:**
```python
# Lines 7-19: Only safe imports
import os  # Used for: environ, path operations only
import sys
import json
import sqlite3  # Safe - parameterized queries
from datetime import datetime, date
from http.server import HTTPServer, BaseHTTPRequestHandler
# No subprocess or shell-related imports
```

**Risk Level:** ğŸŸ¢ **NONE** - No shell execution capability

---

## 5. Client-Side Manipulation

### Status: âš ï¸ **AWARE** (Expected Behavior)

**Why it's not a concern:**
- Application is **read-only** - no data modification endpoints
- Client-side JavaScript only for UI (line 400-527)
- Server validates all requests server-side
- No authentication/authorization to bypass

**What users can manipulate:**
- View different calendar groups (intended)
- Copy URLs (intended)
- Subscribe to calendars (intended)

**What users CANNOT do:**
- Modify deadline data (no POST/PUT/DELETE endpoints)
- Access restricted data (no authentication system to bypass)
- Inject data into database (no write API)

**Risk Level:** ğŸŸ¢ **ACCEPTABLE** - Public read-only service by design

---

## 6. Cross-Site Request Forgery (CSRF/XSRF)

### Status: âœ… **NOT APPLICABLE**

**Why we're not vulnerable:**
- **No state-changing operations** (no POST, PUT, DELETE endpoints)
- All endpoints are GET and idempotent
- No authentication system
- No actions that modify data

**Endpoints analysis:**
- `GET /` - Serve index page
- `GET /calendar/*.ics` - Serve calendar (read-only)
- `GET /api/groups` - List groups (read-only)
- `GET /api/deadlines` - List deadlines (read-only)

**Risk Level:** ğŸŸ¢ **N/A** - No state changes possible

---

## 7. Server-Side Request Forgery (SSRF)

### Status: âœ… **NOT APPLICABLE**

**Why we're not vulnerable:**
- Application does **not** make HTTP requests
- No `urllib.request`, `requests`, or `httplib` imports
- No URL parameters that trigger server-side fetches
- No proxy functionality
- No webhook/callback features

**Code verification:**
- Lines 1-19: No HTTP client imports
- No outbound network connections in code

**Risk Level:** ğŸŸ¢ **N/A** - Feature not present

---

## 8. Connection Interception / Session Stealing

### Status: âœ… **PROTECTED** (Server-Level)

**Why we're protected:**
- **HTTPS/TLS configured at web server level** (user confirmed)
- Application runs behind IIS with SSL certificate
- No session cookies used (stateless application)
- No authentication tokens

**Deployment recommendation (SECURITY.md):**
- Use IIS reverse proxy with HTTPS termination
- Calendar data is public, so minimal impact if intercepted

**Risk Level:** ğŸŸ¢ **LOW** - Public data + HTTPS at proxy level

---

## 9. Password Vulnerabilities

### Status: âœ… **NOT APPLICABLE**

**Why we're not vulnerable:**
- **No password storage** - no authentication system
- No user accounts
- No login functionality
- Public service by design

**Risk Level:** ğŸŸ¢ **N/A** - No passwords used

---

## 10. Brute Force Attacks

### Status: âœ… **PROTECTED** (As of latest updates)

**Why we're protected:**
- **Rate limiting implemented** (lines 36-77)
- IP-based request limiting: 100 requests/60 seconds (default)
- HTTP 429 response when exceeded
- Automatic cleanup prevents memory bloat

**Code implementation (line 45-65):**
```python
def is_allowed(self, client_ip):
    if not os.environ.get('RATE_LIMIT_ENABLED', 'true').lower() == 'true':
        return True
    current_time = time.time()
    with self.lock:
        self.requests[client_ip] = [
            req_time for req_time in self.requests[client_ip]
            if current_time - req_time < self.window_seconds
        ]
        if len(self.requests[client_ip]) >= self.max_requests:
            return False
        self.requests[client_ip].append(current_time)
        return True
```

**Configurable in .env:**
- `RATE_LIMIT_ENABLED=true`
- `RATE_LIMIT_MAX_REQUESTS=100`
- `RATE_LIMIT_WINDOW_SECONDS=60`

**Risk Level:** ğŸŸ¢ **PROTECTED** - Rate limiting active

---

## 11. File Permissions

### Status: âš ï¸ **REQUIRES MANUAL CONFIGURATION**

**Why this needs attention:**
- File permissions set at OS level (Windows)
- Application cannot enforce this itself
- Shared server with other applications

**Protection measures documented:**
- SECURITY.md provides PowerShell commands for:
  - Creating dedicated service account
  - Setting NTFS permissions with `icacls`
  - Restricting database file access (lines in SECURITY.md)

**Configuration required:**
```powershell
# Set ownership to CalendarService account
icacls . /setowner "CalendarService" /T

# Remove inherited permissions
icacls . /inheritance:r

# Grant only necessary permissions
icacls . /grant "CalendarService:(OI)(CI)F"
icacls deadlines.db /grant "CalendarService:RW"
```

**Risk Level:** ğŸŸ¡ **MEDIUM** - Requires administrator action during deployment

---

## 12. Exposed Passwords/Tokens in Repositories

### Status: âœ… **PROTECTED**

**Why we're protected:**
- `.gitignore` updated to exclude `.env` files (line 3-5)
- Environment variables used for configuration
- `.env.example` provided as template (no secrets)
- No hardcoded credentials in code

**.gitignore contents:**
```
__pycache__/
*.pyc
.env
*.env
.env.local
```

**Risk Level:** ğŸŸ¢ **PROTECTED** - Proper gitignore configuration

---

## 13. XML Parsing Vulnerabilities

### Status: âœ… **NOT APPLICABLE**

**Why we're not vulnerable:**
- **No XML parsing** in application
- Uses JSON for API responses (line 827, 855)
- Uses ICS format for calendars (line 817) - not XML
- No `xml.etree`, `lxml`, or XML-related imports

**Code verification:**
- Lines 1-19: No XML imports
- Line 14: Uses `ics` library (not XML-based)

**Risk Level:** ğŸŸ¢ **N/A** - No XML processing

---

## 14. Redirect Spoofing

### Status: âœ… **NOT APPLICABLE**

**Why we're not vulnerable:**
- **No redirect functionality** in application
- No HTTP 301/302 responses
- No `Location` headers sent
- No URL parameters that trigger redirects

**Code verification:**
- All responses are 200 (success), 204 (no content), 404 (not found), or 429 (rate limit)
- Lines 180-183, 789, 809, 823, 850: Response types verified

**Risk Level:** ğŸŸ¢ **N/A** - No redirects implemented

---

## 15. Regular Expression Denial of Service (ReDoS)

### Status: âœ… **NOT APPLICABLE**

**Why we're not vulnerable:**
- **No regular expressions used** in application
- No `re` module imported
- String matching uses simple methods:
  - `.startswith()` (line 83)
  - `.strip()` (lines 78, 92-95, 104-109)
  - Simple string comparison

**Code verification:**
- Lines 1-19: No `import re`
- No pattern matching with regex

**Risk Level:** ğŸŸ¢ **N/A** - No regex processing

---

## 16. File Injection

### Status: âœ… **NOT APPLICABLE**

**Why we're not vulnerable:**
- **No file upload functionality**
- Application only serves calendar files (read-only)
- No POST endpoints that accept file data
- No multipart/form-data handling

**Endpoints analysis:**
- Only `do_GET()` method implemented (line 247)
- No `do_POST()`, `do_PUT()`, or file upload handlers

**Risk Level:** ğŸŸ¢ **N/A** - No file uploads possible

---

## 17. Path Traversal

### Status: âœ… **PROTECTED** (As of latest updates)

**Why we're protected:**
- **Path validation implemented** (lines 80-98)
- Database path restricted to application directory
- Validates `.db` extension only
- Resolves absolute paths and checks containment

**Code implementation (line 80-98):**
```python
def validate_db_path(db_path):
    """Validate database path to prevent path traversal attacks."""
    app_dir = Path(__file__).parent.resolve()
    db_path_abs = (app_dir / db_path).resolve()

    try:
        db_path_abs.relative_to(app_dir)
    except ValueError:
        raise ValueError(f"Database path must be within application directory: {app_dir}")

    if db_path_abs.suffix != '.db':
        raise ValueError("Database file must have .db extension")

    return str(db_path_abs)
```

**Attacks prevented:**
- `--db ../../../other-app/sensitive.db` âŒ Blocked
- `--db C:\Windows\System32\config.db` âŒ Blocked
- `--db ../../passwords.txt` âŒ Blocked (wrong extension)

**Risk Level:** ğŸŸ¢ **PROTECTED** - Robust validation implemented

---

## 18. Character Encoding Attacks

### Status: âœ… **PROTECTED**

**Why we're protected:**
- **Consistent UTF-8 encoding** throughout application
- Line 72: File opened with `encoding='utf-8'`
- Line 791, 817, 824, 851: HTTP headers specify `charset=utf-8`
- SQLite uses UTF-8 by default
- Python 3 strings are Unicode-native

**Code examples:**
```python
# Line 72: TSV import with explicit encoding
with open(tsv_path, 'r', encoding='utf-8') as f:

# Line 791: HTTP response with charset
self.send_header('Content-Type', 'text/html; charset=utf-8')

# Line 817: Calendar response with charset
self.send_header('Content-Type', 'text/calendar; charset=utf-8')
```

**Risk Level:** ğŸŸ¢ **PROTECTED** - Consistent UTF-8 usage

---

## 19. Logging Sensitive Information

### Status: âœ… **SAFE**

**Why we're safe:**
- Logging only includes HTTP request info (line 987-988)
- No passwords or tokens to log (public service)
- Standard HTTP access log format
- No sensitive data in application

**Logging implementation:**
```python
def log_message(self, format, *args):
    print(f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] {format % args}")
```

**Risk Level:** ğŸŸ¢ **SAFE** - No sensitive data logged

---

## 20. Insecure Deserialization

### Status: âœ… **SAFE**

**Why we're safe:**
- No `pickle.loads()` or `pickle.load()` used
- JSON parsing only (safe for untrusted data)
- Line 10: `import json` - used for serialization only (outbound)
- No deserialization of external data

**Code verification:**
- Line 827: `json.dumps()` - safe (serialization, not deserialization)
- Line 855: `json.dumps()` - safe
- No user-provided data deserialized

**Risk Level:** ğŸŸ¢ **SAFE** - No insecure deserialization

---

## Summary Table

| Vulnerability | Status | Risk Level | Notes |
|--------------|--------|------------|-------|
| 1. XSS | âœ… Protected | ğŸŸ¢ Low | DOM methods used, enum values only |
| 2. SQL Injection | âœ… Protected | ğŸŸ¢ None | Parameterized queries |
| 3. Email Header Injection | âœ… N/A | ğŸŸ¢ N/A | No email functionality |
| 4. Shell Execution | âœ… Protected | ğŸŸ¢ None | No shell calls |
| 5. Client-Side Manipulation | âš ï¸ Aware | ğŸŸ¢ OK | Read-only by design |
| 6. CSRF | âœ… N/A | ğŸŸ¢ N/A | No state changes |
| 7. SSRF | âœ… N/A | ğŸŸ¢ N/A | No HTTP requests |
| 8. Session Stealing | âœ… Protected | ğŸŸ¢ Low | HTTPS + no sessions |
| 9. Password Storage | âœ… N/A | ğŸŸ¢ N/A | No authentication |
| 10. Brute Force | âœ… Protected | ğŸŸ¢ Protected | Rate limiting active |
| 11. File Permissions | âš ï¸ Manual | ğŸŸ¡ Medium | Requires OS configuration |
| 12. Exposed Secrets | âœ… Protected | ğŸŸ¢ Protected | .gitignore configured |
| 13. XML Parsing | âœ… N/A | ğŸŸ¢ N/A | No XML used |
| 14. Redirect Spoofing | âœ… N/A | ğŸŸ¢ N/A | No redirects |
| 15. ReDoS | âœ… N/A | ğŸŸ¢ N/A | No regex |
| 16. File Injection | âœ… N/A | ğŸŸ¢ N/A | No uploads |
| 17. Path Traversal | âœ… Protected | ğŸŸ¢ Protected | Validation implemented |
| 18. Encoding Attacks | âœ… Protected | ğŸŸ¢ Protected | UTF-8 consistent |
| 19. Sensitive Logging | âœ… Safe | ğŸŸ¢ Safe | No sensitive data |
| 20. Insecure Deserialization | âœ… Safe | ğŸŸ¢ Safe | No deserialization |

---

## Overall Security Rating: ğŸŸ¢ **GOOD**

### Strengths:
- âœ… Proper database parameterization
- âœ… Rate limiting implemented
- âœ… Path traversal protection
- âœ… No dangerous operations (shell, eval, XML)
- âœ… Public read-only design minimizes attack surface
- âœ… HTTPS at proxy level

### Required Actions:
1. âš ï¸ **Set file permissions during deployment** (see SECURITY.md)
2. âš ï¸ Configure Windows Firewall rules
3. âš ï¸ Create dedicated service account
4. âš ï¸ Set up IIS reverse proxy

### Risk to Other Applications on Server:
ğŸŸ¢ **LOW** - Provided:
- File permissions are set correctly (NTFS)
- Service runs under dedicated account
- Firewall rules configured
- Application directory isolated

### Deployment Checklist:
- [ ] Follow SECURITY.md Windows Server setup
- [ ] Set NTFS permissions on application directory
- [ ] Create `.env` from `.env.example`
- [ ] Configure rate limits for expected traffic
- [ ] Run as Windows Service with limited account
- [ ] Configure IIS reverse proxy for HTTPS
- [ ] Set Windows Firewall rules
- [ ] Test rate limiting functionality
- [ ] Monitor logs for suspicious activity

**Last Updated:** 2025-10-03
